<div ng-include="'components/navbar/navbar.html'"></div>

<div class="panel">
<div class="term">
  <button type="button" class="btn btn-lg btn-default" ng-click="chooseTopic('ebola')">
    Ebola
  </button>
  <button type="button" class="ebola btn btn-lg btn-default" ng-click="getTopic('ebola')">
    Show Ebola
  </button>
  <div class="row">
        <div class="col-md-8 pull-right">
          <table class="table table-bordered table-striped table-condensed">
            <thead>
              <tr>
                <th>#</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Jacob</td>
                <td>Thornton</td>
                <td>@fat</td>
              </tr>
              <tr>
                <td>3</td>
                <td colspan="2">Larry the Bird</td>
                <td>@twitter</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
</div>
<hr>
<div class="term">
  <button type="button" class="btn btn-default btn-lg" ng-click="chooseTopic('Giants')">
    Giants
  </button>
  <button type="button" class="btn btn-lg btn-default" ng-click="getTopic('Giants')">
    Get Giants
  </button>
  <div class="row">
        <div class="col-md-8 pull-right">
          <table class="table table-bordered table-striped table-condensed">
            <thead>
              <tr>
                <th>#</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Jacob</td>
                <td>Thornton</td>
                <td>@fat</td>
              </tr>
              <tr>
                <td>3</td>
                <td colspan="2">Larry the Bird</td>
                <td>@twitter</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
</div>
<hr>
<div class="term">
  <button type="button" class="btn btn-default btn-lg" ng-click="chooseTopic('Kinetech')">
    Kinetech
  </button>
  <div class="row">
        <div class="col-md-8 pull-right">
          <table class="table table-bordered table-striped table-condensed">
            <thead>
              <tr>
                <th>#</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Jacob</td>
                <td>Thornton</td>
                <td>@fat</td>
              </tr>
              <tr>
                <td>3</td>
                <td colspan="2">Larry the Bird</td>
                <td>@twitter</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
</div>
<hr>
<div class="term">
  <button type="button" class="btn btn-default btn-lg" ng-click="chooseTopic('Hack Reactor')">
    Hack Reactor
  </button>
  <div class="row">
        <div class="col-md-8 pull-right">
          <table class="table table-bordered table-striped table-condensed" >
            <thead>
              <tr>
                <th>#</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Username</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              <tr>
                <td>2</td>
                <td>Jacob</td>
                <td>Thornton</td>
                <td>@fat</td>
              </tr>
              <tr>
                <td>3</td>
                <td colspan="2">Larry the Bird</td>
                <td>@twitter</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
</div>

</div><div class="display"><div id="container"></div>
		<script src="js/globe.js"></script>
    <script src="js/orbitControls.js"></script>
    <script>
      $(function(){
        $('.ebola').on('click', function(){
          getTweets();
        })
      });
    
      var getTweets = function(){
        $.ajax({
          type: "GET",
          url: 'api/tweets/getTweets/ebola',
          success: function(data){
            renderTweets(data);
          }
        });
      } 
      
      var nextFuncReady = true;
      
      var render = function(){
        renderer.render(scene, camera);
      };
      var animate = function(){
        requestAnimationFrame(animate);
        TWEEN.update();
        render();
      };
      var container = document.getElementById('container');
      var w = 0, h = 0;
      var el = container;
      while (el){
        w += el.offsetLeft;
        h += el.offsetTop;
        el = el.offsetParent;
      }
      w = window.innerWidth - w;
      h = window.innerHeight - h;
      var globe = new Globe(200);
      window.scene = new THREE.Scene();
      window.camera = new THREE.PerspectiveCamera(90, w / h, 5, 5000);
      window.renderer = new THREE.WebGLRenderer({precision: 'highp', preserveDrawingBuffer: true, antialiasing: true});
      var orbitControls = new THREE.OrbitControls(camera);
      var light = new THREE.DirectionalLight(0xffffff, 1);
      scene.add(new THREE.AmbientLight(0x404040));
      light.position.set(500, 0, 0);
      camera.lookAt(scene.position);
      camera.position.set(0.0, 0.0, 500);
      renderer.setSize(w, h);
      globe.position.set(0.0, 0.0, 0.0);
      scene.add(globe);
      scene.add(light);
      container.appendChild(renderer.domElement);
      orbitControls.addEventListener('change', render);
      render();
      animate();
      
      var leapIsOn = true;

      orbitControls.addEventListener( 'change', render );
      orbitControls.minDistance = 8;
      orbitControls.maxDistance = 8000;

      window.orbitControls = orbitControls;

      if (leapIsOn) {
        leapController = new Leap.Controller({ enableGestures: false });
        leapController.connect();
        // leapController.on( 'connect' , onControllerConnect);

        var dx = 0.001;
        var dy = 0.001;
        var dz = 0.001;

        leapController.on( 'animationFrame' , function( frame ) {

          for(var h = 0; h < frame.hands.length; h++){
            var hand = frame.hands[h];
            window.hand = hand;
            var position = hand.palmPosition;
            var direction = hand.direction;
            var timer = new Date().getTime() * 0.0005;

            var lr = hand.palmPosition[0];
            var ud = hand.palmPosition[2];
            var zoom = hand.palmPosition[1];
            var vel = hand.palmVelocity;
            var v = Math.sqrt(vel[0] * vel[0] + vel[1] * vel[1] + vel[2] * vel[2]);

            if(hand.confidence > 0.5 && v < 400){
              if(hand.pinchStrength < 0.4){ //hand open
                if(Math.abs(lr) > 80){
                  orbitControls.rotateLeft(0.01 * lr / Math.abs(lr));
                }else if(Math.abs(ud) > 80){
                  var offset = ud;
                  orbitControls.rotateUp(0.01 * offset / Math.abs(offset));
                }else if(Math.abs(zoom - 250) > 50){
                  var offset = zoom - 250;
                  if(offset > 0) {
                    orbitControls.dollyIn(1.01);
                  } else {
                    orbitControls.dollyOut(1.01);
                  }
                }
                orbitControls.update()
              }else if(hand.pinchStrength > 0.8){
                if(nextFuncReady){
                  // if(nextFunc == undefined)
                  //   initNextFunc();
                  // nextFunc();
                  getTweets();
                  nextFuncReady = false;
                  setTimeout(function(){nextFuncReady = true;}, 10000);
                }
              }
            }
          }
        });
      }
      
      var renderTweets = function(tweets){
        var i = 1;
        var renderLoop = function(){
          var testSource = globe.getEcef(tweets[i - 1].latitude, -tweets[i - 1].longitude, 0);
          var testTarget = globe.getEcef(tweets[i].latitude, -tweets[i].longitude, 0);
          globe.drawEdge(testSource, testTarget, 'yellow', true, 5);
          if (tweets[i].in_reply_to_screen_name !== null) {
            var color = 'blue';
          } else {
            var color = 'orange';
          }
          globe.flash({lat: tweets[i].latitude, lon: -tweets[i].longitude, size: tweets[i].followers_count / 800, color: color });         
          setTimeout(function(){
            if (i < tweets.length) {
              console.log(tweets[i].in_reply_to_screen_name);
              renderLoop(tweets[i++]);       
            }
          }, 5);   
        }
        renderLoop();
      }
    
      
    </script>
</div>

<footer class="footer">
  <div class="container">
      <p>Made at Hack Reactor in conjunction with Kinetech |
        <!-- <a href="https://twitter.com/tyhenkel">@tyhenkel</a> | -->
         <a href="https://github.com/HR-Data-Geyser/Data-Geyser/issues?state=open">Issues</a></p>
  </div>
</footer>
